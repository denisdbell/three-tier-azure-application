{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "adminUsername": { "type": "string", "defaultValue": "azureuser" },
    "adminPassword": { "type": "securestring" },
    "vnetName": { "type": "string", "defaultValue": "PetClinic-VNet" }
  },
    "variables": {
    "vmSize": "Standard_B1s", 
    "ubuntuImage": {
      "publisher": "Canonical",
      "offer": "0001-com-ubuntu-server-jammy",
      "sku": "22_04-lts-gen2",
      "version": "latest"
    }
  },
  "resources": [
    {
      "type": "Microsoft.Network/networkInterfaces",
      "apiVersion": "2023-05-01",
      "name": "web-nic",
      "location": "[resourceGroup().location]",
      "properties": {
        "ipConfigurations": [{
          "name": "ipconfig1",
          "properties": { "subnet": { "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), 'Web-Subnet')]" } }
        }]
      }
    },
    {
      "type": "Microsoft.Compute/virtualMachines",
      "apiVersion": "2023-03-01",
      "name": "PetClinic-Web-VM",
      "location": "[resourceGroup().location]",
      "dependsOn": [ "[resourceId('Microsoft.Network/networkInterfaces', 'web-nic')]" ],
      "properties": {
        "hardwareProfile": { "vmSize": "[variables('vmSize')]" },
        "storageProfile": { "imageReference": "[variables('ubuntuImage')]" },
        "osProfile": {
          "computerName": "web-tier",
          "adminUsername": "[parameters('adminUsername')]",
          "adminPassword": "[parameters('adminPassword')]",
          "customData": "[base64(concat('#!/bin/bash\n', 'apt-get update\n', 'apt-get install -y nginx\n', 'systemctl start nginx'))]"
        },
        "networkProfile": { "networkInterfaces": [{ "id": "[resourceId('Microsoft.Network/networkInterfaces', 'web-nic')]" }] }
      }
    },
    {
      "type": "Microsoft.Network/networkInterfaces",
      "apiVersion": "2023-05-01",
      "name": "app-nic",
      "location": "[resourceGroup().location]",
      "properties": {
        "ipConfigurations": [{
          "name": "ipconfig1",
          "properties": { "subnet": { "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), 'App-Subnet')]" } }
        }]
      }
    },
    {
      "type": "Microsoft.Compute/virtualMachines",
      "apiVersion": "2023-03-01",
      "name": "PetClinic-App-VM",
      "location": "[resourceGroup().location]",
      "dependsOn": [ "[resourceId('Microsoft.Network/networkInterfaces', 'app-nic')]" ],
      "properties": {
        "hardwareProfile": { "vmSize": "[variables('vmSize')]" },
        "storageProfile": { "imageReference": "[variables('ubuntuImage')]" },
        "osProfile": {
          "computerName": "app-tier",
          "adminUsername": "[parameters('adminUsername')]",
          "adminPassword": "[parameters('adminPassword')]",
          "customData": "[base64(concat('#!/bin/bash\n', 'apt-get update\n', 'apt-get install -y openjdk-17-jdk maven git\n', 'cd /home/azureuser\n', 'git clone https://github.com/spring-projects/spring-petclinic.git\n', 'cd spring-petclinic\n', './mvnw package -DskipTests\n', 'nohup java -jar target/*.jar > /home/azureuser/app.log 2>&1 &'))]"
        },
        "networkProfile": { "networkInterfaces": [{ "id": "[resourceId('Microsoft.Network/networkInterfaces', 'app-nic')]" }] }
      }
    },
    {
      "type": "Microsoft.Network/networkInterfaces",
      "apiVersion": "2023-05-01",
      "name": "db-nic",
      "location": "[resourceGroup().location]",
      "properties": {
        "ipConfigurations": [{
          "name": "ipconfig1",
          "properties": { "subnet": { "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), 'Data-Subnet')]" } }
        }]
      }
    },
    {
      "type": "Microsoft.Compute/virtualMachines",
      "apiVersion": "2023-03-01",
      "name": "PetClinic-DB-VM",
      "location": "[resourceGroup().location]",
      "dependsOn": [ "[resourceId('Microsoft.Network/networkInterfaces', 'db-nic')]" ],
      "properties": {
        "hardwareProfile": { "vmSize": "[variables('vmSize')]" },
        "storageProfile": { "imageReference": "[variables('ubuntuImage')]" },
        "osProfile": {
          "computerName": "db-tier",
          "adminUsername": "[parameters('adminUsername')]",
          "adminPassword": "[parameters('adminPassword')]",
          "customData": "[base64(concat('#!/bin/bash\n', 'apt-get update\n', 'apt-get install -y postgresql postgresql-contrib\n', 'systemctl start postgresql'))]"
        },
        "networkProfile": { "networkInterfaces": [{ "id": "[resourceId('Microsoft.Network/networkInterfaces', 'db-nic')]" }] }
      }
    }
  ]
}
